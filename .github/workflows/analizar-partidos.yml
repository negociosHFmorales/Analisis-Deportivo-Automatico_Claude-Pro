name: Analizar Partidos Deportivos

# Este workflow se ejecuta cuando:
# 1. Se crea un nuevo issue
# 2. Cada dÃ­a a las 8 AM automÃ¡ticamente  
# 3. Manualmente cuando quieras
on:
  issues:
    types: [opened]
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  analizar:
    # Acepta tÃ­tulos con o sin tilde, mayÃºsculas o minÃºsculas
    if: |
      contains(toLower(github.event.issue.title), 'analisis de partidos') || 
      contains(toLower(github.event.issue.title), 'anÃ¡lisis de partidos') ||
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Descargar cÃ³digo del repositorio
        uses: actions/checkout@v4
      
      - name: ðŸ Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # Paso adicional para debugear
      - name: ðŸ” Mostrar informaciÃ³n del evento
        run: |
          echo "Tipo de evento: ${{ github.event_name }}"
          echo "TÃ­tulo del issue: ${{ github.event.issue.title }}"
          echo "Cuerpo del issue: ${{ github.event.issue.body }}"
          echo "Hora actual: $(date)"
      
      - name: ðŸ“¦ Instalar librerÃ­as de Python
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scipy requests python-dateutil
          echo "âœ… Dependencias instaladas correctamente"
      
      - name: ðŸŒ Probar conectividad a internet
        run: |
          echo "Probando conectividad..."
          curl -I https://api.the-odds-api.com/v4/sports/ || echo "Sin conectividad a The Odds API"
          curl -I https://v3.football.api-sports.io/ || echo "Sin conectividad a API-Sports"
      
      - name: ðŸ† Ejecutar anÃ¡lisis (versiÃ³n de prueba)
        run: |
          echo "ðŸš€ Iniciando anÃ¡lisis deportivo..."
          echo "Creando archivo de prueba..."
          cat > resultados_prueba.txt << 'EOF'
          ðŸŽ¯ ANÃLISIS DEPORTIVO - MODO PRUEBA
          ðŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S')
          
          ðŸ“Š ESTADO DEL SISTEMA:
          âœ… GitHub Actions funcionando correctamente
          âœ… Python configurado
          âœ… Dependencias instaladas
          
          ðŸ”§ PRÃ“XIMOS PASOS:
          1. Configurar API keys en Settings â†’ Secrets
          2. Habilitar APIs deportivas
          3. Ejecutar anÃ¡lisis con datos reales
          
          ðŸ’¡ CONSEJO:
          Este es un anÃ¡lisis de prueba. Una vez configuradas las APIs,
          recibirÃ¡s datos reales de partidos y cuotas deportivas.
          EOF
          
          echo "âœ… Archivo de resultados creado"
          cat resultados_prueba.txt
      
      - name: ðŸ“Š Comentar resultados en el issue
        uses: actions/github-script@v7
        if: github.event_name == 'issues'
        with:
          script: |
            const fs = require('fs');
            let resultado = 'âŒ No se pudo generar el reporte';
            
            // Intentar leer el archivo de resultados
            try {
              if (fs.existsSync('resultados_prueba.txt')) {
                resultado = fs.readFileSync('resultados_prueba.txt', 'utf8');
              }
            } catch (error) {
              console.log('Error leyendo archivo:', error);
              resultado = `âŒ Error tÃ©cnico: ${error.message}`;
            }
            
            // Obtener fecha en formato colombiano
            const ahora = new Date();
            const fechaCol = ahora.toLocaleString('es-CO', {
              timeZone: 'America/Bogota',
              weekday: 'long',
              year: 'numeric',
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            // Crear el comentario
            const comentario = `## ðŸ¤– AnÃ¡lisis Deportivo Automatizado
            
${resultado}

---
**ðŸ“… Procesado:** ${fechaCol}  
**ðŸ”§ Sistema:** GitHub Actions  
**ðŸ“ UbicaciÃ³n:** BogotÃ¡, Colombia  
**âœ¨ Estado:** Funcionando correctamente`;

            // Publicar comentario
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comentario
            });
            
            console.log('âœ… Comentario publicado exitosamente');
      
      - name: ðŸ’¾ Guardar resultados como archivo descargable
        uses: actions/upload-artifact@v4
        with:
          name: analisis-deportivo-${{ github.run_number }}
          path: resultados_prueba.txt
          retention-days: 7
